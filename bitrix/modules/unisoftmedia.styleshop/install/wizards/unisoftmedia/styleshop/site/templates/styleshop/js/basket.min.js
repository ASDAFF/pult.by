!function(t,e,a,s){"use strict";function n(){this.$element=null,this.elementId=null,this.add2basket="?action=ADD2BASKET&id=",this.inputQuantity="input[name=quantity]",this.productClass=".js-item",this.product={loading:"",showClosePopup:!1,basketUrl:"",inBasket:"",outBasket:"",basketAction:""},this.$basketElement=null,this.basketItemId=null,this.basketAction="basketAction",this.precision=6,this.precisionFactor=Math.pow(10,this.precision),this.qtyTimeout=null,this.processing=!1,this.initialize()}n.prototype.initialize=function(){var e=this;t(function(){t(a).on("blur",".qty",function(){e.blurQuantity(this)}),t(a).on("click",".quantity [type=button]",function(){t(this).hasClass("quantity-up")?e.QuantityUp(this):t(this).hasClass("quantity-down")&&e.QuantityDown(this)}),e.setQuantity()})},n.prototype.add=function(a){var s,i,n=this,o={};return!n.isProcessing()&&(n.$element=a,n.elementId=parseInt(n.$element.attr("data-elementid")),n.product=t.extend({},n.product,BX.parseJSON(n.$element.data("options"))),s=n.product.detailPageUrl?n.product.detailPageUrl:"",s+=n.add2basket+n.elementId,i=parseFloat(n.$element.closest(n.productClass).find(n.inputQuantity).val()),o={ajax_basket:"Y"},!isNaN(i)&&i>0&&(o.quantity=i),void(null===n.elementId||n.$element.hasClass("disabled")||(n.$element.addClass("disabled"),n.product.loading&&n.$element.children(".text").text(n.product.loading),n.setProcessing(!0),t.ajax({url:s,data:o}).done(function(s){n.setProcessing(!1);var i=BX.parseJSON(s);return a.removeClass("disabled"),"object"!=typeof i||"OK"!=i.STATUS?(console.log(s),!1):void("BUY"===n.product.basketAction?n.BasketRedirect():(n.product.showClosePopup===!0&&t(e).width()>=768&&n.popup(),BX.onCustomEvent("OnBasketChange"),n.product.inBasket&&n.product.basketUrl&&t(".add2basket_"+n.elementId).each(function(){t(this).removeClass("add2basket").attr("title",n.product.inBasket).children(".text").text(n.product.inBasket),t(this).attr("href",n.product.basketUrl)})))}).fail(function(t){console.log("Cannot add to cart")}))))},n.prototype.BasketRedirect=function(){location.href=this.product.basketUrl?this.product.basketUrl:e.location},n.prototype.popup=function(){var e=this;t.fancybox({type:"ajax",autoSize:!0,minWidth:700,maxWidth:1200,maxHeight:700,ajax:{dataType:"html",headers:{"X-fancyBox":!0},data:{ajax_add2basket:"Y",elementId:e.elementId}},helpers:{title:{type:"inside",position:"top"}},title:e.$element.data("title-popup"),href:e.$element.data("url")?e.$element.data("url"):e.$element.attr("href"),openEffect:"fade",closeEffect:"fade"})},n.prototype.setQuantity=function(e){var s=this;t(a).on("click",".js-quantity-update",function(){s.updateQuantity(t(this))})},n.prototype.updateQuantity=function(t){var e=this;e.$basketElement=t.closest(".item"),e.basketItemId=t.data("element");var a=e.$basketElement.find(".qty"),s=a.val(),i={basketItemId:e.basketItemId,sessid:BX.bitrix_sessid(),site_id:BX.message("SITE_ID"),action_var:e.basketAction,props:{},price_vat_show_value:"Y",select_props:"NAME,DISCOUNT,PRICE,QUANTITY,SUM,PROPS,DELETE,DELAY"};i[e.basketAction]="recalculate",i["QUANTITY_"+e.basketItemId]=s,clearTimeout(e.qtyTimeout),e.qtyTimeout=setTimeout(function(){var t=new Loader;t.add(e.$basketElement),BX.ajax({url:"/bitrix/components/bitrix/sale.basket.basket/ajax.php",method:"POST",data:i,dataType:"json",onsuccess:function(a){t.end(),"SUCCESS"==a.CODE?(e.updateBasket(a),BX.onCustomEvent("OnBasketChange")):console.log(a)}})},500)},n.prototype.blurQuantity=function(e){var e=t(e),a=parseFloat(e.val()),s=0<parseFloat(e.attr("step"))?parseFloat(e.attr("step")):1,i="true"==e.attr("data-check");if(isNaN(a))a=s;else{if(a=parseFloat(e.val().replace(/\,/,".")),i===!0){var n=parseFloat(e.attr("data-max"));!isNaN(n)&&a>n&&(a=n)}if(a<s)a=s;else{var o=Math.round(a*this.precisionFactor/s)/this.precisionFactor,r=parseInt(o,10);isNaN(r)&&(r=1,o=1.1),o>r&&(a=r<=1?s:r*s,a=Math.round(a*this.precisionFactor)/this.precisionFactor)}}return e.val(a)},n.prototype.QuantityUp=function(e){var a=this,e=t(e),s=e.closest(".quantity").find(".qty"),i=parseFloat(s.val()),n=0<parseFloat(s.attr("step"))?parseFloat(s.attr("step")):1,o="true"==s.attr("data-check"),r=!0;isNaN(i)||s.val(function(t,e){if(i=parseFloat(e)+parseFloat(n),i=Math.round(i*a.precisionFactor)/a.precisionFactor,o===!0){var l=parseFloat(s.attr("data-max"));!isNaN(l)&&i>l&&(r=!1)}return r||(i=e),i})},n.prototype.QuantityDown=function(e){var a=this,e=t(e),s=e.closest(".quantity").find(".qty"),i=parseFloat(s.val()),n=0<parseFloat(s.attr("step"))?parseFloat(s.attr("step")):1,o=!0;isNaN(i)||s.val(function(t,e){return i=parseFloat(e)-parseFloat(n),i=Math.round(i*a.precisionFactor)/a.precisionFactor,i<n&&(o=!1),o||(i=n),i})},n.prototype.updateBasket=function(e){if("object"==typeof e){if(e.hasOwnProperty("WARNING_MESSAGE")){var a="";for(i=e.WARNING_MESSAGE.length-1;i>=0;i--)a+=e.WARNING_MESSAGE[i]+"<br/>";BX("warning_message").innerHTML=a}e.BASKET_DATA&&(e.BASKET_DATA.allSum_FORMATED&&t(".allSum_FORMATED").html(e.BASKET_DATA.allSum_FORMATED.replace(/\s/g,"&nbsp;")),e.BASKET_DATA.allWeight_FORMATED&&t(".allWeight_FORMATED").html(e.BASKET_DATA.allWeight_FORMATED.replace(/\s/g,"&nbsp;")),e.BASKET_DATA.allSum_wVAT_FORMATED&&t(".allSum_wVAT_FORMATED").html(e.BASKET_DATA.allSum_wVAT_FORMATED.replace(/\s/g,"&nbsp;")),e.BASKET_DATA.allVATSum_FORMATED&&t(".allVATSum_FORMATED").html(e.BASKET_DATA.allVATSum_FORMATED.replace(/\s/g,"&nbsp;")),e.BASKET_DATA.PRICE_WITHOUT_DISCOUNT&&e.BASKET_DATA.allSum_FORMATED&&t(".PRICE_WITHOUT_DISCOUNT").html(e.BASKET_DATA.PRICE_WITHOUT_DISCOUNT!=e.BASKET_DATA.allSum_FORMATED?e.BASKET_DATA.PRICE_WITHOUT_DISCOUNT.replace(/\s/g,"&nbsp;"):""))}},n.prototype.isProcessing=function(){return this.processing===!0},n.prototype.setProcessing=function(t){this.processing=t===!0},e.Basket=new n}(window.jQuery,window,document);