!function(){function t(t){this.caller=t.caller,this.formNode=t.formNode,this.controlNode=t.controlNode,this.inputNode=t.inputNode,this.config=t.config}t.prototype={},BX.UserConsent={msg:{title:"MAIN_USER_CONSENT_REQUEST_TITLE",btnAccept:"MAIN_USER_CONSENT_REQUEST_BTN_ACCEPT",btnReject:"MAIN_USER_CONSENT_REQUEST_BTN_REJECT",loading:"MAIN_USER_CONSENT_REQUEST_LOADING",errTextLoad:"MAIN_USER_CONSENT_REQUEST_ERR_TEXT_LOAD"},events:{save:"main-user-consent-request-save",refused:"main-user-consent-request-refused",accepted:"main-user-consent-request-accepted"},textList:{},current:null,autoSave:!1,isFormSubmitted:!1,isConsentSaved:!1,attributeControl:"data-bx-user-consent",load:function(t){var e=this.find(t)[0];return e?(this.bind(e),e):null},loadAll:function(t,e){this.find(t,e).forEach(this.bind,this)},loadFromForms:function(){var t=document.getElementsByTagName("FORM");t=BX.convert.nodeListToArray(t),t.forEach(this.loadAll,this)},find:function(t){if(!t)return[];var e=t.querySelectorAll("["+this.attributeControl+"]");return e=BX.convert.nodeListToArray(e),e.map(this.createItem.bind(this,t)).filter(function(t){return!!t})},bind:function(t){t.config.submitEventName?BX.addCustomEvent(t.config.submitEventName,this.onSubmit.bind(this,t)):t.formNode&&BX.bind(t.formNode,"submit",this.onSubmit.bind(this,t)),BX.bind(t.controlNode,"click",this.onClick.bind(this,t))},createItem:function(e,n){var i=n.querySelector('input[type="checkbox"]');if(i)try{var o=JSON.parse(n.getAttribute(this.attributeControl)),s={formNode:null,controlNode:n,inputNode:i,config:o};return"FORM"==e.tagName?s.formNode=e:s.formNode=BX.findParent(i,{tagName:"FORM"}),s.caller=this,new t(s)}catch(r){return null}},onClick:function(t,e){this.requestForItem(t),e.preventDefault()},onSubmit:function(t,e){return this.isFormSubmitted=!0,this.check(t)?!0:(e&&e.preventDefault(),!1)},check:function(t){return t.inputNode.checked?(this.saveConsent(t),!0):(this.requestForItem(t),!1)},requestForItem:function(t){this.setCurrent(t),this.requestConsent(t.config.id,{sec:t.config.sec,replace:t.config.replace},this.onAccepted,this.onRefused)},setCurrent:function(t){this.current=t,this.autoSave=t.config.autoSave,this.actionRequestUrl=t.config.actionUrl},onAccepted:function(){if(this.current){var t=this.current;this.saveConsent(this.current,function(){BX.onCustomEvent(t,this.events.accepted,[]),BX.onCustomEvent(this,this.events.accepted,[t]),this.isConsentSaved=!0,this.isFormSubmitted&&t.formNode&&!t.config.submitEventName&&BX.submit(t.formNode)}),this.current.inputNode.checked=!0,this.current=null}},onRefused:function(){BX.onCustomEvent(this.current,this.events.refused,[]),BX.onCustomEvent(this,this.events.refused,[this.current]),this.current.inputNode.checked=!1,this.current=null,this.isFormSubmitted=!1},initPopup:function(){this.popup||(this.popup={})},popup:{isInit:!1,caller:null,nodes:{container:null,shadow:null,head:null,loader:null,content:null,textarea:null,buttonAccept:null,buttonReject:null},onAccept:function(){this.hide(),BX.onCustomEvent(this,"accept",[])},onReject:function(){this.hide(),BX.onCustomEvent(this,"reject",[])},init:function(){if(this.isInit)return!0;var t=document.querySelector("script[data-bx-template]");if(!t)return!1;var e=document.createElement("DIV");return e.innerHTML=t.innerHTML,(e=e.children[0])?(document.body.insertBefore(e,document.body.children[0]),this.isInit=!0,this.nodes.container=e,this.nodes.shadow=this.nodes.container.querySelector("[data-bx-shadow]"),this.nodes.head=this.nodes.container.querySelector("[data-bx-head]"),this.nodes.loader=this.nodes.container.querySelector("[data-bx-loader]"),this.nodes.content=this.nodes.container.querySelector("[data-bx-content]"),this.nodes.textarea=this.nodes.container.querySelector("[data-bx-textarea]"),this.nodes.buttonAccept=this.nodes.container.querySelector("[data-bx-btn-accept]"),this.nodes.buttonReject=this.nodes.container.querySelector("[data-bx-btn-reject]"),this.nodes.buttonAccept.textContent=BX.message(this.caller.msg.btnAccept),this.nodes.buttonReject.textContent=BX.message(this.caller.msg.btnReject),BX.bind(this.nodes.buttonAccept,"click",this.onAccept.bind(this)),BX.bind(this.nodes.buttonReject,"click",this.onReject.bind(this)),!0):!1},setTitle:function(t){this.nodes.head&&(this.nodes.head.textContent=t)},setContent:function(t){this.nodes.textarea&&(this.nodes.textarea.textContent=t)},show:function(t){"boolean"==typeof t&&(this.nodes.loader.style.display=t?"none":"",this.nodes.content.style.display=t?"":"none"),this.nodes.container.style.display=""},hide:function(){this.nodes.container.style.display="none"}},requestConsent:function(t,e,n,i){if(e=e||{},e.id=t,!this.popup.isInit){if(this.popup.caller=this,!this.popup.init())return;BX.addCustomEvent(this.popup,"accept",n.bind(this)),BX.addCustomEvent(this.popup,"reject",i.bind(this))}this.current&&this.current.config.text&&(this.textList[t]=this.current.config.text),this.textList.hasOwnProperty(t)?this.setTextToPopup(this.textList[t]):(this.popup.setTitle(BX.message(this.msg.loading)),this.popup.show(!1),this.sendActionRequest("getText",e,function(e){this.textList[t]=e.text||"",this.setTextToPopup(this.textList[t])},function(){this.popup.hide(),alert(BX.message(this.msg.errTextLoad))}))},setTextToPopup:function(t){var e="",n=t.indexOf("\n"),i=t.indexOf(".");n=i>n?n:i,n>=0&&100>=n&&(e=t.substr(0,n).trim(),e=e.split(".").map(Function.prototype.call,String.prototype.trim).filter(String)[0]),this.popup.setTitle(e?e:BX.message(this.msg.title)),this.popup.setContent(t),this.popup.show(!0)},saveConsent:function(t,e){this.setCurrent(t);var n={id:t.config.id,sec:t.config.sec,url:window.location.href};if(t.config.originId){var i=t.config.originId;if(t.formNode&&i.indexOf("%")>=0){var o=t.formNode.querySelectorAll('input[type="text"], input[type="hidden"]');o=BX.convert.nodeListToArray(o),o.forEach(function(t){t.name&&(i=i.replace("%"+t.name+"%",t.value?t.value:""))})}n.originId=i}t.config.originatorId&&(n.originatorId=t.config.originatorId),BX.onCustomEvent(t,this.events.save,[n]),BX.onCustomEvent(this,this.events.save,[t,n]),this.isConsentSaved||!t.config.autoSave?e&&e.apply(this,[]):this.sendActionRequest("saveConsent",n,e,e)},sendActionRequest:function(t,e,n,i){n=n||null,i=i||null,e.action=t,e.sessid=BX.bitrix_sessid(),e.action=t,BX.ajax({url:this.actionRequestUrl,method:"POST",data:e,timeout:10,dataType:"json",processData:!0,onsuccess:BX.proxy(function(t){t=t||{},t.error?i.apply(this,[t]):n&&n.apply(this,[t])},this),onfailure:BX.proxy(function(){var t={error:!0,text:""};i&&i.apply(this,[t])},this)})}},BX.ready(function(){BX.UserConsent.loadFromForms()})}();